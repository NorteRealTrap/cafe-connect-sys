import { auth } from '@/lib/auth'
export const runtime = 'nodejs'
import { NextRequest, NextResponse } from 'next/server'   import { prisma } from '@/lib/prisma' import { createTableSchema } from '@/lib/validations/table' import { z } from 'zod'  export async function GET(request: NextRequest) {   try {     const session = await auth()     if (!session) {       return NextResponse.json({ error: 'NÃ£o autorizado' }, { status: 401 })     }      const { searchParams } = new URL(request.url)     const establishmentId = searchParams.get('establishmentId')     const status = searchParams.get('status')      if (!establishmentId) {       return NextResponse.json({ error: 'establishmentId Ã© obrigatÃ³rio' }, { status: 400 })     }      const where: any = { establishmentId }     if (status) where.status = status      const tables = await prisma.table.findMany({       where,       include: {         orders: {           where: { status: { notIn: ['COMPLETED', 'CANCELLED'] } },           include: {             items: {               include: {                 product: { select: { id: true, name: true, price: true } }               }             }           }         }       },       orderBy: { number: 'asc' }     })      const tablesWithInfo = tables.map(table => ({       ...table,       currentOrder: table.orders[0] || null,       totalOrders: table.orders.length,       totalAmount: table.orders.reduce((sum, order) => sum + order.total.toNumber(), 0)     }))      return NextResponse.json(tablesWithInfo)   } catch (error) {     console.error('Error fetching tables:', error)     return NextResponse.json({ error: 'Erro ao buscar mesas' }, { status: 500 })   } }  export async function POST(request: NextRequest) {   try {     const session = await auth()     if (!session) {       return NextResponse.json({ error: 'NÃ£o autorizado' }, { status: 401 })     }      if (!['ADMIN', 'MANAGER'].includes(session.user.role)) {       return NextResponse.json({ error: 'Sem permissÃ£o para criar mesas' }, { status: 403 })     }      const body = await request.json()     const validatedData = createTableSchema.parse(body)      const existing = await prisma.table.findFirst({       where: {         establishmentId: validatedData.establishmentId,         number: validatedData.number       }     })      if (existing) {       return NextResponse.json({ error: 'JÃ¡ existe uma mesa com este nÃºmero' }, { status: 409 })     }      const table = await prisma.table.create({       data: { ...validatedData, status: 'AVAILABLE' }     })      return NextResponse.json(table, { status: 201 })   } catch (error) {     if (error instanceof z.ZodError) {       return NextResponse.json({ error: 'Dados invÃ¡lidos', details: error.errors }, { status: 400 })     }     console.error('Error creating table:', error)     return NextResponse.json({ error: 'Erro ao criar mesa' }, { status: 500 })   } }  
